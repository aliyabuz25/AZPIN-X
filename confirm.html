<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZPIN-X | Email Təsdiqi</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/src/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#fcfcfd] text-black min-h-screen flex items-center justify-center px-6">
    <div class="max-w-md w-full border border-zinc-200 bg-white shadow-2xl p-8">
        <div id="status-icon" class="w-14 h-14 border-4 border-accent border-t-transparent rounded-full animate-spin mx-auto"></div>
        <h1 id="status-title" class="text-lg font-black uppercase tracking-widest text-center mt-6">Təsdiqlənir</h1>
        <p id="status-text" class="text-sm text-zinc-600 font-medium text-center mt-3">
            Hesabınız təsdiqlənir, zəhmət olmasa gözləyin...
        </p>
        <div class="mt-6 flex justify-center">
            <a href="/" class="px-6 py-3 bg-accent text-white font-black text-xs uppercase tracking-widest">
                Ana Səhifəyə Dön
            </a>
        </div>
    </div>

    <script type="module">
        import { supabase } from '/src/supabase.js'

        const statusIcon = document.getElementById('status-icon')
        const statusTitle = document.getElementById('status-title')
        const statusText = document.getElementById('status-text')

        const setStatus = (ok, text) => {
            statusIcon.className = ok
                ? 'w-14 h-14 rounded-full bg-accent text-white flex items-center justify-center mx-auto'
                : 'w-14 h-14 rounded-full bg-zinc-900 text-white flex items-center justify-center mx-auto'
            statusIcon.innerHTML = ok ? '<i class="ri-check-line text-3xl"></i>' : '<i class="ri-close-line text-3xl"></i>'
            statusTitle.textContent = ok ? 'Təsdiqləndi' : 'Xəta'
            statusText.textContent = text
        }

        const params = new URLSearchParams(window.location.search)
        const code = params.get('code')

        const hash = new URLSearchParams(window.location.hash.replace('#', ''))
        const access_token = hash.get('access_token')
        const refresh_token = hash.get('refresh_token')

        const run = async () => {
            if (code) {
                const { error } = await supabase.auth.exchangeCodeForSession(code)
                if (error) {
                    setStatus(false, 'Təsdiq zamanı xəta baş verdi. Zəhmət olmasa yenidən yoxlayın.')
                    return
                }
                setStatus(true, 'Email təsdiqi uğurla tamamlandı. Giriş edə bilərsiniz.')
                setTimeout(() => (window.location.href = '/'), 1500)
                return
            }

            if (access_token && refresh_token) {
                const { error } = await supabase.auth.setSession({ access_token, refresh_token })
                if (error) {
                    setStatus(false, 'Təsdiq zamanı xəta baş verdi. Zəhmət olmasa yenidən yoxlayın.')
                    return
                }
                setStatus(true, 'Email təsdiqi uğurla tamamlandı. Giriş edə bilərsiniz.')
                setTimeout(() => (window.location.href = '/'), 1500)
                return
            }

            setStatus(false, 'Təsdiq linki etibarsızdır.')
        }

        run()
    </script>
</body>

</html>
